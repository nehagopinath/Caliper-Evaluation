/*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
* http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

'use strict';

module.exports.info = 'Merging Gradients and applying to the weight matrix.';

const helper = require('./helper');

let txIndex = 0;
let gradients = [[ 2.85279741e-13,3.11415286e-12,-9.13212804e-13,3.35422494e-13, 1.80471444e-13,7.59314597e-13,-2.29160043e-12,-6.96012545e-13, 2.32668710e-12,2.75032454e-13,8.89940111e-13,1.54948079e-12, 2.13876445e-12,2.28860149e-12,-8.13460183e-13,2.29622623e-12,-1.52954994e-12,9.31200714e-13,-6.57695096e-13,-2.71254024e-12, 3.54937519e-12,1.80410662e-12,7.47514758e-13,2.19721956e-12, 1.75927508e-12,8.43874977e-13,8.78353007e-13,9.57950676e-13, 4.36453963e-13,8.65312434e-13,-2.49511081e-12,2.85672282e-12, 1.28021796e-12,1.07018085e-12,-5.64553681e-14,-2.68509785e-12, 1.80310578e-12,2.79869301e-12,-2.37077752e-12,1.94066077e-12, 5.87918621e-13,-1.86308849e-12,-3.08130831e-13,1.21942321e-12, 1.30512387e-13,1.56423282e-12,-1.69365275e-12,2.97982072e-12, -9.17071875e-13,-1.61404158e-12,2.07800747e-12,4.16149941e-12, 3.66425939e-12,-3.17488003e-12,-1.47855042e-12,1.66159245e-12, -1.00659109e-12,-1.67972257e-12,-1.86323563e-12,-3.23045535e-12, 7.87974098e-13,1.37299096e-13,1.44423340e-12,-7.73668779e-13, 2.52675629e-12,8.98294844e-13,2.74600914e-12,-2.40811622e-13, 1.56211154e-12,-7.22770759e-13,1.83066656e-12,1.22499961e-13, 2.12304303e-12,-1.59146321e-12,-3.55299403e-12,-9.53936551e-13, -8.49568529e-13,-1.77164944e-12,2.54223044e-12,3.18855503e-12, 1.24200367e-12,-1.05758675e-12,-4.11362947e-13,2.20932583e-12, 2.75976776e-12,-2.01287326e-12,2.41455080e-12,1.24888339e-12, 9.83421929e-13,-1.93382134e-12,6.86264327e-13,-2.17673918e-12, -1.01776592e-12,-2.19534023e-12,-6.70493579e-13,2.67493533e-12, -9.97827277e-13,-2.59975696e-14,-3.38159191e-12,2.99255705e-12, -5.52375917e-13]];
let features =  ['0.10572406, 0.91595082 ,0.35016653, 0.02093526 ,0.67601366 ,0.72042311,0.207757,0.92903684,0.22563185,0.53090442,0.30456452,0.24825099,0.5821079,0.03619469,0.67627776,0.15567882,0.00551343,0.472628270.88015614,0.78040512,0.29532854,0.34534527,0.88018854,0.54359622,0.46012367,0.50252878,0.37520822,0.82200858,0.66034508,0.81774636,0.05895416,0.64508442,0.45470569,0.3707541,0.80369881,0.75710213,0.89981797,0.05040452,0.12840006,0.00945613,0.98824923,0.49733622,0.21568003,0.54749908,0.85927285,0.59634861,0.12291062,0.7923277,0.35962883,0.84785433,0.29170562,0.59664034,0.33987524,0.75342239,0.5363834,0.52126503,0.82512304,0.8439661,0.99125642,0.80308125,0.14177082,0.09097848,0.35605293,0.89164305,0.86704903,0.62706087,0.98526968,0.30126965,0.04859672,0.92852027,0.83359824,0.47758515,0.63976957,0.81684871,0.1097653,0.92613015,0.0977296,0.68145566,0.82296057,0.9073856,0.34812287,0.12781503,0.51144535,0.88640231,0.2570124,0.7835450,0.65370131,0.06096928,0.37486846,0.29172594,0.06985576,0.07656962,0.25201382,0.53105139,0.904251,0.2850229,0.00934305,0.21019013,0.16675499,0.93558772,0.0511242'];

let bc, contx, limitIndex;

module.exports.init = async function(blockchain, context, args) {
    bc = blockchain;
    contx = context;
    limitIndex = args.assets;

   // await helper.createWeightMatrix(bc, contx, limitIndex);
    await helper.createInitialGradients(bc, contx, limitIndex);

    return Promise.resolve();

};

module.exports.run = function() {
    txIndex++;
    let modelNumber = 'Client' + contx.clientIdx + '_MODEL' + txIndex.toString();
    let gradient = gradients[Math.floor(Math.random() * gradients.length)];
    let weight = features[Math.floor(Math.random() * features.length)];


    let args = {
        chaincodeFunction: 'mergeAndUpdateTest',
        chaincodeArguments: [gradient.toString(),weight.toString(), modelNumber]

    };

    if (txIndex === limitIndex) {
        txIndex = 0;
    }

    return bc.invokeSmartContract(contx, 'model', 'v1', args, 60);
};

module.exports.end = async function() {
    return Promise.resolve();
};
